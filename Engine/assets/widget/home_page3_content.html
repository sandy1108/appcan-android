<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">
    <head>
        <title></title>
        <meta charset="utf-8">
        <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <link rel="stylesheet" href="css/fonts/font-awesome.min.css">
        <link rel="stylesheet" href="css/ui-box.css">
        <link rel="stylesheet" href="css/ui-base.css">
        <link rel="stylesheet" href="css/ui-color.css">
        <link rel="stylesheet" href="css/appcan.icon.css">
        <link rel="stylesheet" href="css/appcan.control.css">
        <link rel="stylesheet" href="css/common.css">
        <link rel="stylesheet" href="css/new_file.css">
        <link rel="stylesheet" href="css/loader.css">
        <style>
        .lin3-hiden{
            height: 1.2em;
            overflow: hidden;
            -webkit-box-orient: vertical;
        }
        .pHeight{
            height:11.5em;
        }
        </style>
    </head>
    <!--鸣家栏目模板 -->
    <body class="um-vp f-f" ontouchstart>
       <div id="ocontent" class="ub ub-f1 ub-ver myVisibilityHide">
           <div class="ub ub-ver" id="newsTop">
               
           </div>
           <div class="ub ub-ver" id="userList">
               
           </div>
           <div class="ub ub-ver" id="newsItem">
               
           </div>
       </div>
        <script src="js/newAppcan.js"></script>
        <script src="js/appcan.control.js"></script>
        <script src="js/common.js"></script>
        <script src="js/interface.js"></script>
        <script src="js/common.dom.js"></script>
    </body>
    <script>
        var icache;
        var pageNum = 1;        //当前页数
        var pageCount = 1;      //总条数
        var arrobjId = [];      //点击过的数组
        var status=1;//加载控制
        var sliderHeight="";
        var sliderId="";
        var itemInfo={};
        var tmplNo1 = '';
        var tmplNoto ='';
        var tmpls = '';
        
        var columnId="",
            isShowDate=1,
            isShowSummary=1,
            conditions="",
            isSlide=0,
            slideType=0;
        appcan.ready(function() {
            var parameter=zy_parse();
            console.log("模板三传入参数=====>");
            console.log(parameter);
            columnId=parameter.pageName;
            isShowDate=parameter.isShowDate;
            isShowSummary=parameter.isShowSummary;
            //alert(columnId);
            conditions={
                "isSummary":parseInt(isShowSummary),
                "isComment":1,
                "isPtime":parseInt(isShowDate)
            };
            
            icache = appcan.icache({maxtask:5});
            appcan.window.subscribe('home_page_content',function (num){getlist(num)});
            appcan.window.subscribe('changeCommentCount',function (msg){
                   var $commentNumDom=$("#commentNum_"+msg);
                   var num= $commentNumDom.html();
                   if(num==""){
                       $commentNumDom.html(1);  
                   }else{
                       $commentNumDom.html(parseInt(num)+1);
                   }
             })
            //点赞数的回掉
            appcan.window.subscribe('home_page_zan',function (sid){
                var numStr = $("#"+sid).html();
                $("#"+sid).html(parseInt(numStr) + 1);
            });
           //浏览量监听
            appcan.window.subscribe('home_page_bq',function (sid){
                var numStr = $("#bq_"+sid).html();
                $("#bq_"+sid).html(parseInt(numStr) + 1);
            });
            appcan.window.subscribe("sliderHeight",function (msg){
                 sliderHeight=msg;
                //alert("名家===>"+msg);
                 if(msg>11.5){
                     $("#"+sliderId).css("height",msg+"px");
                 }else{
                     $("#"+sliderId).css("height",msg+"em");
                 }
             });
             
            if(isAndroid){
                var param_slip = {
                    isSupport:true   //(必选)true:支持；false:不支持。默认为false。
                }
                uexWindow.setIsSupportSlideCallback(JSON.stringify(param_slip));//设置网页是否支持滑动的相关监听方法
            }  
            
             //滑动顶部刷新方式
             appcan.frame.setBounce([0,1], null, null, function(type) {
                 isSlide=1;
                 if(status==0){//可能由于网络原因,处理恢复上一次的加载
                     status=1;
                     appcan.frame.resetBounce(slideType);
                 }
                 slideType=type;
                 //判断是否有网
                 GetInfoDevice(function(str){
                     if(!str){
                         appcan.frame.resetBounce(slideType);
                         return false;
                     }else{
                         if (type == 0) {
                             pageNum=1;
                             slists(1);
                             userList();
                         }else{
                            if ((pageNum - 1) * 10 > pageCount) {
                                appcan.frame.resetBounce(slideType);
                            } else {
                                pageNum++;
                                slists(pageNum);
                            }
                         }
                     }
                 });
             },bounceBgColor,imgSettingsVal)
            
            //判断是否有网
             GetInfoDevice(function(str){
                 if(!str){
                     setCacheData();//默认加载首页缓存数据
                 }
             }) 
             
             setCacheData();
            //userList();
            //slists(1);
            var isFirstPage=appcan.locStorage.val('isFirstPage');
            if(isDefine(isFirstPage) && isFirstPage.split("_")[1]==columnId){
                userList();
                slists(1);
            }
        })
        
           //缓存加载首页数据
        function setCacheData(){
            var homeNewsListMJ_item= getLocVal('homeNewsListMJ_item_'+columnId);
            var homeNewsListMJ_users= getLocVal('homeNewsListMJ_users_'+columnId);
            if(isDefine(homeNewsListMJ_item)){
                sliderItem.domShow(2,0,JSON.parse(homeNewsListMJ_item)[0],listFirst);//顶部第一条
                newsItem.domShow(2,1,JSON.parse(homeNewsListMJ_item),newsItemShow_Mj,conditions);//新闻列表显示
            }
            if(isDefine(homeNewsListMJ_users)){
                userListShow(JSON.parse(homeNewsListMJ_users));
            }
        }
        
        //获取资讯
       function slists(pageNo) {
            status=0;
            var if_list=getInterface('newsInfoGetList',columnId,pageNo);//接口封装配置函数
            console.log("newsItem====>"+JSON.stringify(if_list)+"\n"+chongqingUrl);
            //ajax请求
            appcan.request.ajax({
                url : chongqingUrl,
                headers : {
                    token : appcan.locStorage.val("token") || '',
                    deviceId : appcan.locStorage.val("deviceId") || ''
                },
                appVerify:true,
                data : JSON.stringify(if_list),
                timeout : "15000",
                type : "POST",
                contentType : "application/json",
                dataType : "json",
                success : function(res) {
                    console.log(columnId+" >>>模板三newsItem列表返回====>");
                    console.log(res);
                    loader.close();
                    uexWindow.closeToast();
                    appcan.frame.resetBounce(slideType);
                    status=1;
                    if(res.status != '000'){
                        uexWindow.toast(1, 5, res.msg, 2000);
                        return false;
                    }
                    var datas=res.data;
                    pageCount = datas.totalNum;//新闻资讯列表总条数
                    
                    if(pageNum==1){
                        //资讯列表首页显示
                        if(datas.list.length == 0){
                            $('#ocontent').html('<div class="ub ub-f1 ub-ac ub-pc c-66" style="margin-top:1em;">暂无信息</div>');
                            return false;
                        }else{
                            var homeNewsListMJ_item= getLocVal('homeNewsListMJ_item_'+columnId);
                             if(!isDefine(homeNewsListMJ_item) || (base64_encode(homeNewsListMJ_item)!=base64_encode(JSON.stringify(datas.list)))){
                                 sliderItem.domShow(2,0,datas.list[0],listFirst);//顶部第一条
                                 newsItem.domShow(2,1,datas.list,newsItemShow_Mj,conditions);//新闻列表显示
                                 if(isDefine(datas.list)){
                                     setLocVal('homeNewsListMJ_item_'+columnId,JSON.stringify(datas.list));
                                 }
                             }else{
                                 if(isSlide==1){//手动刷新
                                     sliderItem.domShow(2,0,datas.list[0],listFirst);//顶部第一条
                                     newsItem.domShow(2,1,datas.list,newsItemShow_Mj,conditions);//新闻列表显示
                                 }else{
                                     status=1;
                                 }
                            }
                        }
                    }else{
                        //翻页资讯列表显示
                        if(datas.list.length>0){
                            newsItem.domShow(2,0,datas.list,newsItemShow_Mj,conditions);//新闻列表显示
                        }else{
                            status=1;
                        }
                    }
                },
                error : function(xhr, errorType, error,msg) {
                    status=1;
                    appcan.frame.resetBounce(slideType);
                    loader.close();
                    uexWindow.closeToast();
                }
            })
        }
        
       function userList(){
             var if_list=getInterface('userInfoGetList','',1);//接口封装配置函数
             console.log(JSON.stringify(if_list));
            //ajax请求
            appcan.request.ajax({
                url : chongqingUrl,
                headers : {
                    token : appcan.locStorage.val("token") || '',
                    deviceId : appcan.locStorage.val("deviceId") || ''
                },
                appVerify:true,
                data : JSON.stringify(if_list),
                type : "POST",
                contentType : "application/json",
                dataType : "json",
                timeout : "15000",
                success : function(res){
                    console.log(columnId+" >>>模板三中间列表====>");
                    console.log(res);
                    var list=res.data.list;
                    var homeNewsListMJ_users= getLocVal('homeNewsListMJ_users_'+columnId);
                    if(!isDefine(homeNewsListMJ_users)||(base64_encode(homeNewsListMJ_users)!=base64_encode(JSON.stringify(list)))){
                        userListShow(list);
                        if(isDefine(list)){
                             setLocVal('homeNewsListMJ_users_'+columnId,JSON.stringify(list));
                        }
                    }else{
                         if(isSlide==1){//手动刷新
                             userListShow(list);
                         }
                    }
                }
            })
        }
        
        //显示名家列表
        function userListShow(list){
             //用户列表
                tmpls=$('<div class="ub ub-ver"></div>');
                var title=$('<div class="ub ubb ubt b-bf ub ub-ac c-66" style="min-height:1.8em;padding-left:0.5em;font-size:0.825em;">最热大咖</div>');
                var userLisrDom=$('<ul></ul>');
                var userList = $('<li class="ub ub-ac" style="padding:0.35em;"></li>');
                var len=((list.length)>5?5:list.length);
                for(var i = 0;i < len;i++){
                    if(isDefine(list[i])){
                        isDefine(list[i].nickName)?list[i].nickName:(list[i].nickName="");
                        var nickNameVal = (list[i].nickName).length > 3 ? list[i].nickName.substring(0,3) + '..' : list[i].nickName;
                        //list[i].nickName = isDefine(list[i].nickName) ? list[i].nickName : '　';
                        var userIcon = getImgUrl("0",list[i].userIcon,3);
                        //alert(userIcon);
                        var mar = (i == 0) ? '' : 'mar-l05';
                        var item = $('<div class="ub ub-ac ub-ver '+mar+'" style="height:4.25em;width:18%;" onclick="appcan.window.open(\'home_User\',\'home_User.html\',\'10\');setLocVal(\'supUserId\',\''+list[i].userId+'\')"></div>');
                        
                        var img = $('<div class="ub" style="height:3.25em;width:3.25em;border-radius:1.65em;"></div>');
                        var imgTag=$('<img src="css/img/oheadpic.png" alt="" style="height:3.25em;width:3.25em;border-radius:1.65em;"/>');
                        img.append(imgTag);
                        if(isDefine(userIcon)){
                          icache.run({dom:imgTag,url:userIcon});
                        }
                        var nickName = $('<span class="ub ub-ac ub-pc" style="font-size:0.825em;margin-top:0.25em;">'+nickNameVal+'</span>');
                        item.append(img);
                        item.append(nickName);
                        userList.append(item);
                        userLisrDom.append(userList);
                        if(isDefine(userIcon)){
                            icache.run({dom:img,url:userIcon});
                       }
                    }else{
                        var item = $('<div class="ub ub-ver ub-f1 h-5em mar-l05 ma-w4">'
                                 +'</div>');
                        userList.append(item);
                    }
                }
                tmpls.append(title);
                tmpls.append(userLisrDom);
                if(pageNum == 1){ 
                    $("#userList").empty();
                    $('#userList').append(tmpls);
                }
                
        }
        
        //头部slider层展示（页面顶部展示callback）
        function listFirst(datas){
            tmplNoto1 = isDefine(datas.dom)?datas.dom:"";
            itemInfo=$.extend(itemInfo,(isDefine(datas.itemInfo) ? datas.itemInfo:""));
            if(pageNum == 1){
                $('#newsTop').empty();
            }
            $('#newsTop').append(tmplNoto1);
            //头部slider层图片显示
            if(sliderHeight>11.5){
                 $("#"+sliderId).css("height",sliderHeight+"px");
             }else{
                 $("#"+sliderId).css("height",sliderHeight+"em");
             }
        }
        
        //列表回调方法，加载到页面上(列表callback)
        function newsItemShow_Mj(datas){
            tmplNoto = isDefine(datas.dom)?datas.dom:"";
            itemInfo=$.extend(itemInfo,(isDefine(datas.itemInfo) ? datas.itemInfo:""));
            if(pageNum == 1){
                $('#newsItem').html('');
            }
            $('#newsItem').append(tmplNoto);
            $("#ocontent").removeClass("myVisibilityHide");
            //已点击过的变换样式 
            if(getLocVal('arrobjId3')){
                arrobjId = JSON.parse(getLocVal('arrobjId3'));
                for(var i = 0;i < arrobjId.length;i++){
                    $("#"+arrobjId[i]).addClass('c-88');
                }
            }
            
            status=1;
            loader.close();
            uexWindow.closeToast();
            var btn_key=1;
            appcan.button('.btnDetile','btn-act',function(e){
                if(btn_key==1){
                    btn_key=0;
                    var id=$(this);
                    btn_ink(id,e);
                    
                    var newsIdVal = this.id;
                    $(this).addClass('c-88');
                    arrobjId.push(newsIdVal);
                    setLocVal('arrobjId3',JSON.stringify(arrobjId));
                     //传递点击列表信息
                    appcan.locStorage.setVal('newsItemInfo',JSON.stringify(itemInfo[newsIdVal]));
                    if(itemInfo[newsIdVal].newsTypeId==2){
                        //跳转图片新闻展示页面
                        appcan.window.open('home_DetailsPictures','home_DetailsPictures.html',10);
                    }else if(itemInfo[newsIdVal].newsTypeId==5){
                        //跳转专题列表
                        appcan.window.open('spe_page','spe_page.html',10,1024);
                    }else if(itemInfo[newsIdVal].newsTypeId==6){
                        //跳转栏目
                        var goColumnId=itemInfo[newsIdVal].columnId;
                        //alert(goColumnId);
                        uexWindow.evaluateScript("", 0, "openFrame("+goColumnId+")");
                        // appcan.locStorage.setVal("govermentColumnDomIndex","id_"+goColumnId);
                        // uexWindow.evaluateScript("", 0, "goGoverment("+goColumnId+")");
                    }else{
                        //跳转新闻详细页面
                        appcan.window.open('home_Details','home_Details.html',10,1024);
                    }
                    setTimeout(function(){btn_key=1;},2000);
                }
            })
            
            //数据显示完成，关闭预加载页
            closeAdvert();
        }
        
        var $myContent=$("#ocontent");
        function doDisplay(){
            $myContent.removeClass("uhide");
        }
        function doHide(){
            $myContent.addClass("uhide");
        }
        
        function goTop(){
            window.scrollTo(0,0);
        }
    </script>
</html>
