<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">
    <head>
        <title></title>
        <meta charset="utf-8">
        <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <link rel="stylesheet" href="css/fonts/font-awesome.min.css">
        <link rel="stylesheet" href="css/ui-box.css">
        <link rel="stylesheet" href="css/ui-base.css">
        <link rel="stylesheet" href="css/ui-color.css">
        <link rel="stylesheet" href="css/appcan.icon.css">
        <link rel="stylesheet" href="css/appcan.control.css">
        <link rel="stylesheet" href="css/new_file.css">
        <link rel="stylesheet" href="css/common.css">
    </head>
    <body class="um-vp f-f c-wh" style="background-color: #000000" ontouchstart>
        <div id="header" class="uh bc-text-head ub oc_header" style="visibility: hidden;">
            <div class="nav-btn" id="nav-left">
                <div class="ub-img oback"></div>
            </div>
            <h1 class="ut ub-f1 ulev-3 ut-s tx-c" tabindex="0">大图</h1>
            <div class="nav-btn nav-bt" id="nav-right">
                    <div class="ub-img tit_pat_r"></div>
            </div>
        </div>
        <div class="ub ub-ver ub-f1" id="content" style="width: 100%;overflow: hidden">
            <div class="ub ub-f1" style="height: 90%">
                <div id="slider" class="ub ub-ac ub-con" style="height: 100%">
                    <!--
                    <div class='ub-fh ub-img1' onclick="visiHeaFoo()" style="height:100%;background-image: url(http://119.84.14.151:9090/sdk10394/public/3.0/files/558b0488b912bf6247bb0b67)"></div>
                    -->
                </div>
            </div>
            <div class="ub ub-pc ub-f1 fz-8" id="textContent" style="padding: 1em 0;">
            </div>
        </div>
        <div id="footer" class="ub ub-f1 c-66" style="height:2.75em;visibility: hidden;">
            <div class="ub ub-f1 ubt b-aa bg-wh uinn uhide"  id="footer1">
                <div class="ub ub-ac ub-f1 ubr b-ce Hcomment">
                    <div class="pic_foot1 ub-img foot_wh"></div>
                    <span>写评论</span>
                </div>
                <div class="ub ub-f4 ub-ac ub-pj">
                    <div class="ub ub-f1 pic_foot2 ub-img foot_wh">
                        <div class="pos-x" style="display: none" id="pluns"></div>
                    </div>
                    <div class="ub ub-f1 ub-img foot_wh" style="background-image: url('image/praise.png');" id="foot3">
                        <div class="pos-x" style="display: none" id="zambia"></div>
                    </div>
                    <div class="ub ub-f1 pic_foot4 ub-img foot_wh" id="share"></div>
                </div>
            </div>
            <!--<div class="ub ub-f1 ub-ac ub-pc oc_h2 uinn" id="footer2">
                div class="bor-yuan bg-wh mar-l05" name="shootSli" style="padding: .3em"></div>
                <div class="bor-yuan bg-6d mar-l05" name="shootSli" style="padding: .3em"></div>
            </div>-->
            <!-- <div id="footer3" class="ubt bc-border oc_header ub ub-f1 ub-ac ub-pc uinn3 uhide" style="height:2em">
                <div class="uinn4 ub ub-f1" style="margin:0 .5em;">
                    <div class="uinput ub  bc-border uba uc-a1 ub-f1" style="width:82%;background-color: white">
                        <input placeholder="评论内容" type="text" class="ub-f1" id="input_content">
                    </div>
                </div>
                 <div id="handout" class="ub ub-pc uc-a1" style="padding-top:.4em;padding-bottom:0.4em;color:white;margin-right:1em;width: 22%;background-color:#ff8a00">写评论</div>
            </div> -->
        </div>
    </body>
    <script src="js/appcan.js"></script>
    <script src="js/appcan.control.js"></script>
    <script src="js/common.js"></script>
    <script src="js/zy_slide.js"></script>
    <script>
        var slider;
        var objectId,interId,fxText;
        var imageInfos = JSON.parse(appcan.locStorage.val('imageInfos'));
        appcan.ready(function(){
            //alert(appcan.locStorage.val('imageInfos'));
            var titHeight = $('#header').offset().height;
            var titHeight1 = $('#footer').offset().height;
            var height = parseInt(document.body.clientHeight) - parseInt(titHeight) - parseInt(titHeight1)-1;
            $("#content").css('height',height+'px');
            //监听评论数的改变
            appcan.window.subscribe('changeCommentCount',function(id){
                if(imageInfos.interId==id){
                    $("#pluns").html(parseInt(imageInfos.wordsCount)+1);
                }
            })
           getInfo();
            //拍照回调
            uexCamera.cbOpenInternal = function(opCode, dataType, data) {
                var arrUpload = [];
                arrUpload.push(data);
                setLocVal('arrUpload',JSON.stringify(arrUpload));
                appcan.window.open('shoot_add','shoot_add.html',10);
            }
 
            //照片
            uexImageBrowser.cbPick = function(opCode, dataType, data) {
                var arrUpload = data.split(",");
                if(arrUpload.length > 9){
                    appcan.window.openToast('图片最多只能选择9张!',2000);
                    return false;
                }
                setLocVal('arrUpload',JSON.stringify(arrUpload));
                appcan.window.open('shoot_add','shoot_add.html',10);
            };
        });
        
        //进入详情页面
        appcan.button(".pic_foot2","btn-act",function(){
            setLocVal("shootObjId",objectId+"_"+interId);
            appcan.window.open('shoot_details',"shoot_details.html",10);
        })
        //点赞
        appcan.button("#foot3","btn-act",function(){
            dianzan();
        })
        
        //分享代码开始
        appcan.button("#share","btn-act",function(){
            appcan.locStorage.setVal('shareId',objectId+"_"+interId);
            appcan.locStorage.setVal('shareTitle',fxText);
            appcan.locStorage.setVal('shareSummary','');
            appcan.locStorage.setVal('share_type','active');
            shareTypeChoose();
        })
        function shareTypeChoose() {//弹出分享第三方选择(只有footer处调用)
            uexWindow.openPopover("share_content",0,'share_content.html','',0,0,document.body.clientWidth,document.body.clientHeight,32,0,0);
        }
        function sceneChoose() {//弹出分享场景选择
             uexWindow.openPopover("scene_content",0,'scene_content.html','',0,0,document.body.clientWidth,document.body.clientHeight,32,0,0);
        }
        //分享代码结束
        
         //跳转到评论页面
        appcan.button(".Hcomment","btn-act",function(){
            // if(!isUser()){
                // appcan.window.open('login','login.html',10);
                // return false;
            // }
            // $("#footer1").addClass('uhide');
            // $("#footer2").addClass('uhide');
            // $("#footer3").removeClass('uhide');
            
            //if(isUser()){
                setLocVal("shootId",interId);
                setLocVal("detailType",'shoot');
                appcan.window.open('home_Comment','home_Comment.html',10);
            // }else{
                // appcan.window.open('login','login.html');
//                 
            // }
        })
        
        //写评论
        appcan.button("#handout","btn-act",function(){
            var text = $("#input_content").val();
            if(!isDefine(text)){
                appcan.window.openToast('评论信息不能为空!',2000);
                return false;
            }
            appcan.request.ajax({
                url:chongqingUrl,
                headers : {
                    token : appcan.locStorage.val("token") || '',
                    deviceId:appcan.locStorage.val("deviceId") || ''
                },
                appVerify:true,
                data : {
                    "ifno" : "CMS-WORD-0002",
                    "condition" : {
                        "dmnId" : "cq",
                        "grpId" : "",
                        "roleId" : "",
                        "chnlId" : "",
                        "oprTypeId" : "06",
                        "objectId" : "",
                        "wordId" : ""
                    },
                    "content" : {
                        "enttTypeId" : "31",
                        "enttId" : interId || '',
                        "rcvUserId" : "",
                        "content" : text
                    }
                },
                type : "POST",
                contentType : "application/json",
                dataType : "json",
                timeout : "15000",
                success : function(data) {
                    if(data.dispose.status == '000'){
                        $("#input_content").val('');
                        appcan.window.openToast("评论成功",1500,5,0);
                    }else{
                        appcan.window.openToast(data.dispose.msg,2000);
                    }
                },
                error : function() {
                    appcan.window.closeToast();
                }
            });
        })
        
        //document.getElementById('slider').slide=
        slider = new zySlide('slider','H',function(){
            },false,function(e){
                var cur = slider.currentPoint;
                var length = slider.maxPoint;
                console.log(cur+"<----->"+length)
                for(var i = 0;i <= length; i++){
                    $("div[name=shootSli]")[i].className = 'bor-yuan bg-6d mar-l05';
                }
                $("div[name=shootSli]")[cur].className = 'bor-yuan bg-wh mar-l05';
            });
        var hideText = true;
        function visiHeaFoo(){
            if(hideText){
                $("#header").attr('style','visibility: visible;');
                $("#footer1").removeClass('uhide');
                $("#footer2").addClass('uhide');
                hideText = false;
            }else{
                $("#header").attr('style','visibility: hidden;');
                $("#footer1").addClass('uhide');
                $("#footer2").removeClass('uhide');
                hideText = true;
            }
            $("#footer3").addClass('uhide');
        }
        
        appcan.button(".nav-btn", "btn-act", function() {
            switch(this.id){
                case 'nav-left':
                    appcan.window.close(-1);
                    break;
                case 'nav-right':
                    if(!isUser()){
                        appcan.window.open('login','login.html',10);
                        return false;
                    }
                    appcan.window.open('makeComplaints','makeComplaints_add.html',10);
                    break;
            }
        })
        //增加图片
        function openShee(str){
            if(str == 1){
                uexImageBrowser.pickMulti(9);
            }else{
                //uexCamera.open();     //打开系统相机
                //compress   图片是否压缩，0表示压缩，非0或者不传表示不压缩。
                //quality    图片压缩质量，compress为0时有效，取值范围[0,100]。
                //uexCamera.openInternal(compress,quality);
                //uexCamera.openInternal();       //打开自定义相机
                uexCamera.openBandIconInternal('res://camera.png','0','50');
            }
        }
        function getInfo(){
            var imageInfos = JSON.parse(appcan.locStorage.val('imageInfos'));
            var imgList = imageInfos.attachment;        //图片数组
            objectId = imageInfos.objectId;
            interId = imageInfos.interId;
            fxText = imageInfos.content;
            //评论数
            if(imageInfos.wordsCount != '' && imageInfos.wordsCount != undefined && imageInfos.wordsCount != '0'){
                $("#pluns").html(imageInfos.wordsCount);
                $("#pluns").show();
            }
            //赞数
            if(imageInfos.praiseCount != '' && imageInfos.praiseCount != undefined && imageInfos.praiseCount != 0){
                $("#zambia").html(imageInfos.praiseCount);
                $("#zambia").show();
            }
            slider.maxPoint = imgList.length - 1;       //设置slider的最大个数
            var tmpl = '';
            var stmpl = '';
            for(var i = 0; i < imgList.length;i++){
                var shoo = 'bg-6d';
                if(i == 0){
                    shoo = 'bg-wh';
                }
                /*
                // 创建对象
                var img = new Image();
                // 改变图片的src
                img.src = getImgUrl("1",imgList[i].attcId,1);
                var widths = '10.18em';
                if(img.width > img.height){
                    widths = img.width * ( parseInt($("#slider").height()) / img.height)+'px';
                }
                */
                stmpl += '<div class="bor-yuan '+shoo+' mar-l05" name="shootSli" style="padding: .3em"></div>';
                tmpl += '<div class="ub-fh ub-img" onclick="visiHeaFoo()" style="height:100%;background-image: url('+getImgUrl("1",imgList[i].attcId,1)+')"></div>';
            }
            $("#slider").append(tmpl);
            $("#footer2").append(stmpl);
            $("#textContent").html(imageInfos.content);
            $("#footer").attr('style','visibility:visible');
           /*
            var listFun = function(imgWidth,imgHeight,i){
                backNum++;
                var shoo = 'bg-6d';
                if(i == 0){
                    shoo = 'bg-wh';
                }
                var strHeight = '100%';
                var cssText = '';
                if(imgWidth < imgHeight){
                    strHeight = imgWidth * ( parseInt($("#slider").height()) / imgHeight)+'px';
                    cssText = '1';
                    //strHeight = '';
                }
                stmpl += '<div class="bor-yuan '+shoo+' mar-l05" name="shootSli" style="padding: .3em"></div>';
                tmpl += '<div class="ub-fh ub-img" onclick="visiHeaFoo()" style="height:100%;background-image: url('+getImgUrl("1",imgList[i].attcId,1)+')"></div>';
                if((i+1) == imgList.length){
                    $("#slider").append(tmpl);
                    $("#footer2").append(stmpl);
                    $("#textContent").html(imageInfos.content);
                    $("#footer").attr('style','visibility:visible');
                    return false;
                }
                recursion(imgList,listFun);
            }
            recursion(imgList,listFun);
            */
        }
        var backNum = 0;
        function recursion(list,back){
            if(list.length == backNum){
                return false;
            }
            var img = new Image();
            img.src = getImgUrl("1",list[backNum].attcId,1);
            var check = function(){
                // 只要任何一方大于0
                // 表示已经服务器已经返回宽高
                if(img.width>0 || img.height>0){
                    clearInterval(setImg);
                    back(img.width,img.height,backNum);
                }
            };
            var setImg = setInterval(check,40);
        }
        
        
        function dianzan(){
            var dataObj = {
                "ifno": "CMS-INTER-0004",
                "condition": {
                    "dmnId": "cq",
                    "grpId": "",
                    "roleId": "",
                    "chnlId": ""
                },
                "content": {
                    "entity": [
                        {
                        "oprTypeId": "17",
                        "enttTypeId": "31",
                        "enttId": interId
                        }
                    ]
                }
            };
            appcan.request.ajax({
                url:chongqingUrl,
                headers : {
                    token : appcan.locStorage.val("token") || '',
                    deviceId:appcan.locStorage.val("deviceId") || ''
                },
                data : dataObj,
                type : "POST",
                //appVerify:true,
                //offline:true,
                contentType : "application/json",
                dataType : "json",
                timeout : "15000",
                success : function(data) {
                    if(data.info.entity[0].status == '001'){
                        appcan.window.openToast('您已经点过赞了!',2000);
                        return false;
                    }else{
                        $("#zambia").show();
                        var com = $("#zambia").html();
                        if(!isDefine(com)){
                            com = 0;
                        }
                        $("#zambia").html(parseInt(com) + 1);
                        appcan.window.publish('shoot_zan',interId);
                    }
                    
                },
                error : function() {
                }
            })
        }
    </script>
</html>
