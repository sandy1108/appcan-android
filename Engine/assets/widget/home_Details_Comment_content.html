<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">
    <head>
        <title></title>
        <meta charset="utf-8">
        <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <link rel="stylesheet" href="css/fonts/font-awesome.min.css">
        <link rel="stylesheet" href="css/ui-box.css">
        <link rel="stylesheet" href="css/ui-base.css">
        <link rel="stylesheet" href="css/ui-color.css">
        <link rel="stylesheet" href="css/appcan.icon.css">
        <link rel="stylesheet" href="css/appcan.control.css">
        <link rel="stylesheet" href="css/new_file.css">
        <link rel="stylesheet" href="css/detailStyle.css">
        <link rel="stylesheet" href="css/loader.css">
    </head>
    <body class="um-vp f-f1" ontouchstart>
        <div class="ub-ver" id="wordsText">
            <div class="ub ub-ver" id="wordsText1">
                
            </div>
            <div class="ub ub-ver" id="wordsText2">
                
            </div>
            <div class="ub ub-ver" id="wordsText3">
                
            </div>
        </div>
        <script src="js/newAppcan.js"></script>
        <script src="js/appcan.control.js"></script>
        <script src="js/common.js"></script>
        <script src="js/interface.js"></script>
    </body>
    <script>
        var objId = isDefine(getLocVal('objId'))?getLocVal('objId'):"";
        var pageNum = 1;
        var pageCon = 1;
        var userInfo=isDefine(getLocVal('userInfo')) ? getLocVal('userInfo'):"";
        var userId="";
        var userCommentId=""; //对评论的点赞
        var slideType=1;
        appcan.ready(function() {
            userId = isDefine(userInfo)?JSON.parse(userInfo).userId:"";
            appcan.window.subscribe("changeCommentCount",function(msg){
                if(msg==objId){
                    $("#wordsText3").html("");
                    showComment(1,1); //刷新评论
                }
            })
            appcan.frame.setBounce([0,1], null, null, function(type) {
                slideType=type;
                if(type==0){
                    pageNum=1;
                    showComment(1,1);      //最新评论
                }else{
                    if ((pageNum - 1) * 10 > pageCon) {
                        //uexWindow.toast("0", "5", "没有更多内容", "2000");
                        appcan.frame.resetBounce(slideType);
                    } else {
                        pageNum++;
                        showComment(1,pageNum);
                    }
                }
            },bounceBgColor,imgSettingsVal)
            
            loader.open();
            showComment(1,1);      //最新评论
        })
        
         //获取评论的方法
        function showComment(index,page) {
            pageNum = page;
            if(index==1){
                var titleVal="最新评论";
                var conditions={
                    "userId":userId
                };
                var list1=getInterface('commentInfoGetList',objId,pageNum,conditions);//接口封装配置函数
            }else if(index==2){
                var titleVal="名家评论";
                var conditions={
                    "isFamous":1,
                    "userId":userId
                };
                var list1=getInterface('commentInfoGetList',objId,pageNum,conditions);//接口封装配置函数
            }else{
                var titleVal="最热评论";
                var conditions={
                    "isHot":1,
                    "userId":userId 
                };
                var list1=getInterface('commentInfoGetList',objId,pageNum,conditions);//接口封装配置函数
            }
            console.log(JSON.stringify(list1));
            appcan.request.ajax({
                url : chongqingUrl,
                headers : {
                    token : appcan.locStorage.val("token") || '',
                    deviceId : appcan.locStorage.val("deviceId") || ''
                },
                appVerify:true,
                data : JSON.stringify(list1),
                type : "POST",
                contentType : "application/json",
                dataType : "json",
                timeout : "15000",
                success : function(res) {
                    console.log("资讯===>"+titleVal);
                    console.log(res);
                    loader.close();
                    appcan.frame.resetBounce(slideType);
                    var list = res.data.list;
                    pageCon = res.data.totalNum;
                    if(pageNum==1 && list.length==0){
                         $('#wordsText3').html('<div class="ub ub-f1 ub-ac ub-pc c-66" style="margin-top:1em;">暂无信息</div>');
                         return false;
                    }
                    var tmpl = '',
                        tmpl1 = '',
                        time="",
                        nickName = "",
                        nickedName="",
                        commentNickName="",
                        commentedNickName="",
                        commentLoginName="",
                        commentedLoginName="",
                        content="",
                        userIconUrl="",
                        picPrse = '',
                        isSupport=0;
                    for(var i = 0;i < list.length;i++){
                        time = timePoor(list[i].mTime);
                        commentNickName = list[i].commentNickName;
                        if(list[i].commentLoginName!="游客"){
                            commentLoginName=(list[i].commentLoginName).substring(0,3)+'***'+(list[i].commentLoginName).substring(8,11);
                        }else{
                            commentLoginName=list[i].commentLoginName;
                        }
                        nickName=isDefine(commentNickName)?commentNickName:commentLoginName;
                        
                        if(isDefine(list[i].commentedUserId)){
                            //nickName = list[i].commentNickName + ' 对  ' + list[i].commentedNickName + ' 的评论';
                            commentedNickName = list[i].commentedNickName;
                            if(list[i].commentLoginName!="游客"){
                                commentedLoginName=(list[i].commentedLoginName).substring(0,3)+'***'+(list[i].commentedLoginName).substring(8,11);
                            }else{
                                commentedLoginName=list[i].commentedLoginName;
                            }
                            nickedName = isDefine(commentedNickName) ? commentedNickName : commentedLoginName;
                            nickName = nickName + ' 对  ' + nickedName + ' 的评论';
                        }
                        
                        userIconUrl = isDefine(list[i].commentAvatar) ? getImgUrl("1",list[i].commentAvatar,2) : 'css/img/oheadpic.png';
                        isSupport = list[i].isSupport;
                        if(isSupport == 1){
                            picPrse = 'praise2';
                        }else{
                             picPrse = 'praise1';
                        }
                        content=list[i].content
                        if(list[i].userDel==1){
                            content="该评论已删除";
                        }
                            
                        
                        tmpl1 += '<div class="ub uinn uinn-t1">'
                                    +'<div class="ub-img7 wh-2em bor-yuan" style="background-image:url(\''+userIconUrl+'\')"></div>'
                                    +'<div class="ub ub-f1 mar-l1">'
                                        +'<div class="ub ub-f1 ub-ver">'
                                            +'<div class="c-70 fz-8">'+nickName+'</div>'
                                            +'<div class="uinn02 c-46 wrap">'
                                                +content
                                            +'</div>'
                                            +'<div class="ub ub-pj">'
                                                +'<div class="ub c-99 fz-68">'+time+'</div>'
                                                +'<div class="ub ub-ac">'
                                                    +'<div class="wh-1em '+picPrse+' ub-img userSupport" id="'+list[i].commentId+'"></div>'
                                                    +'<div class="c-3c fz-8 umar-lr">'+list[i].supportNum+'</div>&nbsp;&nbsp;&nbsp;&nbsp;'
                                                    +'<div class="wh-1em discuss ub-img" onclick="plComment(\''+list[i].commentId+'\',\''+list[i].commentUserId+'\')"></div>'
                                                +'</div>'
                                            +'</div>'
                                        +'</div>'
                                    +'</div>'
                                +'</div>'
                                +'<div class="ubb b-dd" style="height: 1px"></div>';
                    }
                    
                    tmpl = '<div class="ub ub-f1 uinn-t1" style="margin-left:.5em">'
                                    +'<div class="ub bg-ff w-06em"></div>'
                                    +'<span class="ub ub-ac c-66 mar-l05">'+titleVal+'</span>'
                                +'</div>'
                            +tmpl1;
                            
                    if(!isDefine(tmpl1)){
                        tmpl = '';
                    }
                    if(index==1){
                        if(pageCon>0){
                            $("#wordsText").show();
                            if(pageNum==1){
                                $("#wordsText3").empty();
                                $("#wordsText3").append(tmpl);
                            }else{
                                $("#wordsText3").append(tmpl1);
                            }
                        }
                    }else if(index==2){
                        //点赞数超过100才会显示
                        (pageCon>0)?$("#wordsText1").html(tmpl):"";
                    }else {
                        //点赞数超过100才会显示
                        (pageCon>0)?$("#wordsText2").html(tmpl):"";
                    }
                    //对评论的点赞
                    appcan.button(".userSupport","btn-act",function(){
                       userCommentId=this.id;
                       userAction(userCommentId,4,1,'',userId,userSupportCallBack);
                    })
                },
                error : function() {
                    loader.close();
                    appcan.frame.resetBounce(slideType);
                }
            })
        }
        
         //评论点赞结果回调callback
       function userSupportCallBack(res){
            console.log("对评论的点赞结果返回给页面====>");
            console.log(res);
            if(res.status=="000"){
                $("#"+userCommentId).removeClass('praise1').addClass('praise2');
                var supportNum=parseInt($("#"+userCommentId).next().html())+1;
                $("#"+userCommentId).next().html(supportNum);
            }else if(res.status == "4060") {
                uexWindow.toast(0, 5, "您已经点过赞了", 2000);
            }else{
                uexWindow.toast(0, 5, res.msg, 2000);
            }
       }
        
        
    //对评论的评论
    function plComment(parentCommentId,commentedUserId){
        //传入评论参数
        var commentParameter={
            "objId": objId,
            "objType": 1,
            "parentCommentId":parentCommentId,//被评论的id
            "commentedUserId":commentedUserId //被评论者id
        }
        setLocVal("commentParameter",JSON.stringify(commentParameter));
        appcan.window.open('home_Comment','home_Comment.html',10);
    }
        
    function goTop(){
        window.scrollTo(0,0);
    }
    </script>
</html>