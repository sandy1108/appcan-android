<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">
    <head>
        <title></title>
        <meta charset="utf-8">
        <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <link rel="stylesheet" href="css/fonts/font-awesome.min.css">
        <link rel="stylesheet" href="css/ui-box.css">
        <link rel="stylesheet" href="css/ui-base.css">
        <link rel="stylesheet" href="css/ui-color.css">
        <link rel="stylesheet" href="css/appcan.icon.css">
        <link rel="stylesheet" href="css/appcan.control.css">
        <link rel="stylesheet" href="css/new_file.css">
        <style>
            .addImg {
                background-image: url('twoImg/addimg.png');
            }
            .cameraPic {
                background-image: url('image/camera.png');
            }
            .localPic {
                background-image: url('image/localPicture.png');
            }
            .add_wh {
                width: 4.93em;
                height: 4.93em;
                margin-right: 1em;
                margin-top: 1em;
                float: left;
            }
            .shanchu {
                background-image: url('twoImg/iconfont-shanchu1.png')
            }
            .gsSC {
                position: absolute;
                right: 0;
            }
        </style>
    </head>
    <body class="um-vp f-f bg-wh" ontouchstart>
        <div class="uinput ub ub-f1 uinn-1">
            <textarea placeholder="请输入内容，20字以内..." id="textcon"  maxlength="20" class="ub-f1"  style="min-height: 3em;min-height:8em;border:1px solid #E2E2E2;background-color:#F6F5F5;"></textarea>
            <!-- <textarea placeholder="请输入内容，20字以内..." id="textcon" type="text" maxlength="20" onchange="this.value=this.value.substring(0, 20)" onkeydown="this.value=this.value.substring(0, 20)" onkeyup="this.value=this.value.substring(0, 20)" style="min-height:8em;border:1px solid #E2E2E2;background-color:#F6F5F5;" class="ub-f1"></textarea> -->
        </div>
        <div class="" id="cameras" style="display:none;padding-left:1em">
            <div class="ub-img1 add_wh" id="subImg">
                
            </div>
        </div>
        <div id="chooseStyle">
            <div class="ub ub-pe" style="right:1em">
                <div class="ub ub-img cameraPic" id="style_cameras"  style="height:3em;width:3em;"></div>
                &nbsp;&nbsp;&nbsp;&nbsp; <div class="ub ub-img localPic" id="style_localPictrue" style="height:3em;width:3em;"></div>
            </div>
        </div>
        <script src="js/appcan.js"></script>
        <script src="js/appcan.control.js"></script>
        <script src="js/common.js"></script>
    </body>
    <script>
        var dirPath = '';//上传图片路径
        var num = 0;     //计数器
        var arrUpload = [];//相册选取照片路径
        var imgLength = 0;//图片的个数
        var maxImage = 1;//图片最大个数
        var tNum = 0;
        appcan.ready(function() {
            //拍照回调
            uexCamera.cbOpenInternal = function(opCode, dataType, data) {
                uexWindow.toast(1, 5, "", "");
                $("#cameras").show();
                imgLength++;
                if (imgLength > maxImage) {
                    imgLength--;
                    appcan.window.openToast('上传图片超过' + maxImage + '张', 3000);
                    uexWindow.closeToast();
                    return false;
                }
                if (imgLength == maxImage) {
                    $('#subImg').hide();
                }
                dirPath = data;
                arrUpload = [];
                uexUploaderMgr.createUploader(num, uploadHttp1);
            }
            //照片
            uexImageBrowser.cbPick = function(opCode, dataType, data) {
                uexWindow.toast(1, 5, "", "");
                $("#cameras").show();
                tNum = 0;
                arrUpload = data.split(",");

                imgLength += 1;
                if (imgLength > maxImage) {
                    imgLength -= arrUpload.length;
                    appcan.window.openToast('上传图片超过' + maxImage + '张', 3000);
                    uexWindow.closeToast();
                    return false;
                }
                if (imgLength == maxImage) {
                    $('#subImg').hide();
                }
                createPic();
            };

            //上传
            uexUploaderMgr.onStatus = function(opCode, fileSize, percent, serverPath, status) {
                switch (status) {
                case 0://'文件上传中' + percent + '%'
                    break;
                case 1://文件上传成功
                    uexWindow.closeToast();
                    var serverUrl = JSON.parse(serverPath).url;
                    var imgId = serverUrl.split("/");
                    uexUploaderMgr.closeUploader(num);
                    var imgId = imgId[imgId.length - 1];
                    num++;
                    createPic();
                    $("#cameras").prepend('<div class="ub-img1 add_wh" name="picName" id="' + imgId + '" style="background-image: url(' + getImgUrl("1", imgId, 4) + ')"><div class="shanchu iconSpace15 ub-img gsSC" onclick="delPic(this)"></div></div>');
                    $("#chooseStyle").hide();
                    break;
                case 2:
                    appcan.window.openToast('文件上传失败', 3000, 5);
                    uexUploaderMgr.closeUploader(num);
                    break;
                }
            }
            //创建上传的回调
            uexUploaderMgr.cbCreateUploader = function(opCode, dataType, data) {
                if (data == 0) {
                    uexUploaderMgr.uploadFile(num, dirPath, "uploadFile", 3);
                } else {
                    uexWindow.toast(0, 5, "创建失败", 3000);
                }
            }
            
            var arrload = getLocVal('arrUpload');
            if(isDefine(arrload)){
                arrUpload = JSON.parse(arrload);
                createPic();
                imgLength = arrUpload.length;
                if (arrUpload.length >= maxImage) {
                    $('#subImg').hide();
                }
            }
        });

        //照相机获取图片
        appcan.button("#style_cameras", "btn-act", function() {
            openShee(2);
        })
        //本地获取图片
        appcan.button("#style_localPictrue", "btn-act", function() {
            openShee(1);
        })
        //递归上传多张图片
        function createPic() {
            var lengths = 1;
            if (arrUpload.length > maxImage) {
                lengths = maxImage;
                $('#subImg').hide();
            }
            if (tNum < lengths) {
                dirPath = arrUpload[tNum];
                uexUploaderMgr.createUploader(num, uploadHttp1);
                tNum++;
            }
        }

        //删除图片
        function delPic(dom) {
            $('#subImg').show();
            imgLength--;
            $(dom).parent().remove();
            $('#chooseStyle').show();
        }

        function openShee(str) {
            if (str == 1) {
                uexImageBrowser.pickMulti(9);
            } else {
                uexCamera.openBandIconInternal('res://camera.png', '0', '50');
            }
        }
        
        var statusUP=1;//控制上传，防止误操作重复提交
        function subString() {
            if(statusUP!=1){
                appcan.window.openToast('正在上传',2000);
                return false;
            }
            statusUP=0;
            var attachment = [];
            var imgList = $("div[name='picName']");
            if (imgList.length > 0) {
                for (var i = 0; i < imgList.length; i++) {
                    var imgObj = {};
                    imgObj.attcId = $(imgList[i]).attr("id");
                    imgObj.attcTypeId = '01';
                    imgObj.attcIcon = '';
                    attachment.push(imgObj);
                }
            }
            if (attachment.length > maxImage) {
                appcan.window.openToast('只能上传' + maxImage + '张!', 2000);
                return false;
            }
            var hd_content = $("#textcon").val();
            if (!isDefine(hd_content)) {
                uexWindow.toast("0", "5", "发送内容不能为空!", 2000);
                return false;
            }
            var data1 = {
                "ifno" : "CMS-INTER-0003",
                "condition" : {
                    "dmnId" : "cq",
                    "objectId" : "",
                    "interId" : "",
                    "oprTypeId" : "02",
                    "vrsnNo" : "1"
                },
                "content" : {
                    "interTtl" : "",
                    "interCtt" : hd_content, //标题
                    "interCls" : '', //分类
                    "attachment" : attachment, //图片
                    "interType" : "01"
                }
            };
            appcan.request.ajax({
                headers : {
                    token : appcan.locStorage.val("token") || '',
                    deviceId : appcan.locStorage.val("deviceId") || ''
                },
                appVerify:true,
                type : "POST",
                url : encodeURI(chongqingUrl),
                data : JSON.stringify(data1),
                dataType : "json",
                contentType : "application/json",
                timeout : "15000",
                success : function(data) {
                    statusUP=1;
                    if (data.dispose.status == '000') {
                        uexWindow.toast("0", "5", "发送成功", 2000);
                        
                        var isFromComplaintsSquare=appcan.locStorage.val("isFromComplaintsSquare");
                        if(isFromComplaintsSquare != "1"){
                            appcan.window.open('MCS', 'makeComplaintsSquare.html', 10);
                        }else{
                            appcan.window.evaluatePopoverScript('makeComplaintsSquare','content','MCSList(1);');
                        }
                        
                        setTimeout(function() {
                            appcan.window.evaluateScript('', 'appcan.window.close();');
                        }, 1500);
                    } else if (data.dispose.status == '001') {
                        uexWindow.toast("0", "5", "发送失败", 2000);
                        setTimeout(function() {
                            appcan.window.evaluateScript('', 'appcan.window.close();');
                        }, 3000);
                    } else {
                        uexWindow.toast("0", "5", "发送失败", 2000);
                    }
                    setLocVal('arrUpload','');
                },
                error : function(err) {
                    statusUP=1;
                    setLocVal('arrUpload','');
                    uexWindow.toast("0", "5", "发送失败", 2000);
                }
            });
        }
    </script>
</html>